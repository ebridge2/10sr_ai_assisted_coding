
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.3. Rule 10: Refine Code Incrementally with Focused Objectives &#8212; Ten Simple Rules for AI-assisted Coding in Open Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'rules/quality/rule10';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Conclusion" href="../../conclusion/conclusion.html" />
    <link rel="prev" title="4.2. Rule 9: Critically Review Generated Code" href="rule9.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../coverpage.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Ten Simple Rules for AI-assisted Coding in Open Science - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Ten Simple Rules for AI-assisted Coding in Open Science - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../coverpage.html">
                    Ten Simple Rules for AI-assisted Coding in Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/background.html">Background concepts and vocabulary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The Rules</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../prep/prep.html">1. Preparation &amp; Understanding</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../prep/rule1.html">1.1. Rule 1: Gather Domain Knowledge Before Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prep/rule2.html">1.2. Rule 2: Distinguish Problem Framing from Coding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prep/rule3.html">1.3. Rule 3: Choose Appropriate AI Interaction Models</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../context/context.html">2. Context Engineering &amp; Interaction</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../context/rule4.html">2.1. Rule 4: Start by Thinking Through a Potential Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../context/rule5.html">2.2. Rule 5: Manage Context Strategically</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../testing/testing.html">3. Testing &amp; Validation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing/rule6.html">3.1. Rule 6: Implement Test-Driven Development with AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/rule7.html">3.2. Rule 7: Leverage AI for Test Planning and Refinement</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="quality.html">4. Code Quality</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="rule8.html">4.1. Rule 8: Monitor Progress and Know When to Restart</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule9.html">4.2. Rule 9: Critically Review Generated Code</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.3. Rule 10: Refine Code Incrementally with Focused Objectives</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Conclusion</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../conclusion/conclusion.html">Conclusion</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ebridge2/10sr_ai_assisted_coding" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ebridge2/10sr_ai_assisted_coding/edit/master/paper/rules/quality/rule10.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ebridge2/10sr_ai_assisted_coding/issues/new?title=Issue%20on%20page%20%2Frules/quality/rule10.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/rules/quality/rule10.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Rule 10: Refine Code Incrementally with Focused Objectives</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-separates-positive-from-flawed-examples">4.3.1. What separates positive from flawed examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-vague-improve-this-request">4.3.1.1. Example 1: Vague “Improve This” Request</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-ask-ai-for-diagnostic-feedback-before-refactoring">4.3.1.2. Example 2: Ask AI for Diagnostic Feedback Before Refactoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-incremental-refactoring-with-testing">4.3.1.3. Example 3: Incremental Refactoring with Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-performance-optimization-with-baseline-metrics">4.3.1.4. Example 4: Performance Optimization with Baseline Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-ai-breaks-code-during-refactoring">4.3.1.5. Example 5: AI Breaks Code During Refactoring</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="rule-10-refine-code-incrementally-with-focused-objectives">
<span id="rules-rule-10"></span><h1><span class="section-number">4.3. </span>Rule 10: Refine Code Incrementally with Focused Objectives<a class="headerlink" href="#rule-10-refine-code-incrementally-with-focused-objectives" title="Link to this heading">#</a></h1>
<p>Once you have working, tested code, resist the temptation to ask AI to “improve my codebase.” Instead, approach refinement incrementally with clear, focused objectives. Be explicit about what aspect you want to improve: performance optimization, code readability, error handling, modularity, or adherence to specific design patterns. When you recognize that refinement is needed but can’t articulate the specific approach (for instance, you know certain logic should be extracted into a separate function but aren’t sure how), use AI to help you formulate concrete objectives before implementing changes. Describe what you’re trying to achieve and ask the AI to suggest specific refactoring strategies or design patterns that would accomplish your goal, applying the same mindsets delineated in Rules 1 - 9 to help you along the way.</p>
<p>AI excels at identifying opportunities for refactoring and abstraction, such as recognizing repeated code that should be extracted into reusable functions or methods, and detecting poor programming patterns like deeply nested conditionals, overly long functions, tight coupling between components, sloppy or inconsistent variable naming conventions, and other poor patterns. When requesting refinements, specify the goal (e.g., “extract the data validation logic into a separate function” rather than “make this better”) and verify each change against your tests (or, improving your testing as you interate to reflect the latest updates and improvements) before moving to the next improvement. This focused approach prevents the AI from making changes that, while technically sound, don’t align with your project’s architectural decisions. Note that AI can inadvertently break previously working code or degrade performance while making stylistic improvements. Always test thoroughly after each incremental change, and revert if the “improvement” introduces problems or doesn’t provide clear benefits.</p>
<section id="what-separates-positive-from-flawed-examples">
<h2><span class="section-number">4.3.1. </span>What separates positive from flawed examples<a class="headerlink" href="#what-separates-positive-from-flawed-examples" title="Link to this heading">#</a></h2>
<p>Flawed examples ask AI to “improve” or “clean up” code without specific objectives. The AI makes sweeping changes across multiple concerns simultaneously; renaming variables, restructuring logic, changing algorithms, adding abstractions. You can’t evaluate which changes are beneficial because everything changed at once. Tests start failing but you don’t know which modification caused the problem. The AI might introduce technically correct patterns that don’t match your project’s conventions. You waste time untangling good changes from bad ones, or worse, accept problematic changes because you can’t isolate their effects.</p>
<p>Positive examples approach refinement systematically. You either identify specific issues yourself or ask AI to diagnose problems first, then evaluate its suggestions based on your project context. You tackle one focused objective at a time. You test after each change (improving your testing suite as you go) and revert immediately if something breaks. You recognize that not all AI suggestions are appropriate for your codebase; even good practices can be wrong if they conflict with project or field conventions for specific tendencies or methodologies. This incremental approach lets you understand each change, verify its benefit, and maintain a working codebase throughout refinement.</p>
<hr class="docutils" />
<section id="example-1-vague-improve-this-request">
<h3><span class="section-number">4.3.1.1. </span>Example 1: Vague “Improve This” Request<a class="headerlink" href="#example-1-vague-improve-this-request" title="Link to this heading">#</a></h3>
<p>The user asks AI to generically improve code without specific objectives. The AI makes sweeping changes across multiple dimensions. When tests fail, the user tries to salvage the situation by listing what’s wrong, but the AI’s attempts to fix the problems make things worse. The conversation becomes increasingly polluted with failed attempts, conflicting constraints, and mounting confusion. What started as “improve the code” turns into a debugging nightmare where it’s impossible to tell what’s broken, why, or how to fix it. The user eventually gives up and has to revert everything.</p>
<div class="proof example dropdown admonition" id="rule10-bad-ex1">
<p class="admonition-title"><span class="caption-number">Example 4.9 </span> (Vague “Improve This” Request)</p>
<section class="example-content" id="proof-content">
<p><strong>User Prompt:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">connectivity</span> <span class="n">analysis</span> <span class="n">code</span> <span class="n">works</span> <span class="n">but</span> <span class="n">could</span> <span class="n">be</span> <span class="n">better</span><span class="o">.</span> <span class="n">Clean</span> <span class="n">it</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">improve</span> <span class="n">it</span><span class="o">.</span>

<span class="p">[</span><span class="n">pastes</span> <span class="mi">200</span> <span class="n">lines</span> <span class="n">of</span> <span class="n">working</span> <span class="n">code</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>AI Response:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># AI makes sweeping changes:</span>

<span class="c1"># 1. Renamed everything (mat → connectivity_matrix, compute_stats → analyze_network)</span>
<span class="c1"># 2. Restructured into new class hierarchy (added AbstractConnectivityAnalyzer base)</span>
<span class="c1"># 3. Changed correlation algorithm (Pearson → Spearman without asking)</span>
<span class="c1"># 4. Added caching decorator</span>
<span class="c1"># 5. Introduced dependency injection</span>
<span class="c1"># 6. Switched from numpy to pandas for some operations</span>
<span class="c1"># 7. Added type hints everywhere</span>
<span class="c1"># 8. Extracted 5 new helper functions</span>
<span class="c1"># 9. Changed function signatures</span>
<span class="c1"># 10. Added extensive logging</span>

<span class="c1"># [200 lines of &quot;improved&quot; code that looks completely different]</span>
</pre></div>
</div>
<p><strong>User Runs Tests:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/
<span class="c1"># FAILED: 8 of 15 tests failing</span>
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">refactoring</span> <span class="n">broke</span> <span class="n">things</span><span class="o">.</span> <span class="n">Problems</span> <span class="n">I</span> <span class="n">see</span><span class="p">:</span>

<span class="mf">1.</span> <span class="n">Tests</span> <span class="n">failing</span> <span class="n">because</span> <span class="n">function</span> <span class="n">signatures</span> <span class="n">changed</span>
<span class="mf">2.</span> <span class="n">Spearman</span> <span class="n">correlation</span> <span class="n">gives</span> <span class="n">different</span> <span class="n">results</span> <span class="n">than</span> <span class="n">our</span> <span class="n">validated</span> <span class="n">Pearson</span> <span class="n">approach</span>
<span class="mf">3.</span> <span class="n">The</span> <span class="n">new</span> <span class="k">class</span><span class="w"> </span><span class="nc">hierarchy</span> <span class="ow">is</span> <span class="n">too</span> <span class="nb">complex</span>
<span class="mf">4.</span> <span class="n">Pandas</span> <span class="n">dependency</span> <span class="n">added</span> <span class="n">but</span> <span class="n">we</span><span class="s1">&#39;re minimizing dependencies</span>
<span class="mf">5.</span> <span class="n">The</span> <span class="n">caching</span> <span class="ow">is</span> <span class="n">causing</span> <span class="n">stale</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">some</span> <span class="n">tests</span>
<span class="mf">6.</span> <span class="n">Logging</span> <span class="n">statements</span> <span class="n">are</span> <span class="n">breaking</span> <span class="n">when</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">test</span> <span class="n">environment</span>
<span class="mf">7.</span> <span class="n">Some</span> <span class="n">extracted</span> <span class="n">functions</span> <span class="n">are</span> <span class="n">called</span> <span class="n">only</span> <span class="n">once</span> <span class="p">(</span><span class="n">unnecessary</span> <span class="n">abstraction</span><span class="p">)</span>

<span class="n">Fix</span> <span class="n">these</span> <span class="n">issues</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>AI’s “Fix” Attempt:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># AI tries to address all issues simultaneously:</span>

<span class="c1"># 1. Keeps new function signatures but adds wrapper functions for old signatures</span>
<span class="c1"># 2. Adds parameter to switch between Pearson/Spearman</span>
<span class="c1"># 3. Keeps class hierarchy but adds backward compatibility methods</span>
<span class="c1"># 4. Makes pandas import optional with fallback</span>
<span class="c1"># 5. Adds cache invalidation logic</span>
<span class="c1"># 6. Wraps logging in try/except blocks</span>
<span class="c1"># 7. Inlines some functions but not others (inconsistent)</span>

<span class="c1"># NOW THERE ARE TWO VERSIONS OF EVERYTHING</span>
<span class="c1"># Code is even more complex than before</span>
</pre></div>
</div>
<p><strong>User Tests Again:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/
<span class="c1"># FAILED: 10 of 15 tests failing (WORSE!)</span>

<span class="c1"># New problems appeared:</span>
<span class="c1"># - Wrapper functions have subtle behavioral differences</span>
<span class="c1"># - Pearson/Spearman parameter not threaded through all calls</span>
<span class="c1"># - Backward compatibility methods create duplicate state</span>
<span class="c1"># - Optional pandas import broke type hints</span>
<span class="c1"># - Cache invalidation is too aggressive, now caching nothing</span>
<span class="c1"># - try/except around logging swallows actual errors</span>
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>This is worse! Now we have:
- Wrapper functions that behave slightly differently than originals
- The Pearson/Spearman parameter isn&#39;t being passed through correctly
- More tests failing than before
- Even more complexity

Just revert the Spearman change and remove the wrappers. Keep the original 
function signatures.
</pre></div>
</div>
<p><strong>AI’s Second “Fix”:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># AI tries to revert some changes while keeping others:</span>

<span class="c1"># Removes wrappers but keeps new signatures (CONFLICT!)</span>
<span class="c1"># Changes back to Pearson but keeps the method parameter (unused now)</span>
<span class="c1"># Removes some of the class hierarchy but not all (inconsistent state)</span>
<span class="c1"># Keeps caching in some places but removes it from others</span>
<span class="c1"># Some logging statements removed, others kept</span>

<span class="c1"># THE CODE IS NOW A FRANKENSTEIN MIX OF OLD AND NEW</span>
</pre></div>
</div>
<p><strong>User Tests Again:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/
<span class="c1"># FAILED: 12 of 15 tests failing (EVEN WORSE!)</span>

<span class="c1"># The code is now in an impossible state:</span>
<span class="c1"># - Mix of old and new patterns</span>
<span class="c1"># - Inconsistent state between related functions</span>
<span class="c1"># - Parameters that exist but aren&#39;t used</span>
<span class="c1"># - Class hierarchy that&#39;s partially implemented</span>
<span class="c1"># - Import statements for dependencies that aren&#39;t used</span>
</pre></div>
</div>
<p><strong>User’s Final Attempt:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I</span> <span class="n">can</span><span class="s1">&#39;t even tell what the code is trying to do anymore. We have:</span>
<span class="o">-</span> <span class="n">Vestiges</span> <span class="n">of</span> <span class="n">the</span> <span class="n">old</span> <span class="n">implementation</span> <span class="n">mixed</span> <span class="k">with</span> <span class="n">new</span>
<span class="o">-</span> <span class="n">Unused</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">imports</span> <span class="n">everywhere</span>
<span class="o">-</span> <span class="n">Functions</span> <span class="n">that</span> <span class="n">call</span> <span class="n">each</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">confusing</span> <span class="n">ways</span>
<span class="o">-</span> <span class="n">Tests</span> <span class="n">failing</span> <span class="k">for</span> <span class="n">reasons</span> <span class="n">I</span> <span class="n">can</span><span class="s1">&#39;t diagnose</span>

<span class="n">This</span> <span class="ow">is</span> <span class="n">unsalvageable</span><span class="o">.</span> <span class="n">I</span><span class="s1">&#39;m reverting everything.</span>
</pre></div>
</div>
<p><strong>Git Revert:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>diff<span class="w"> </span>HEAD~1<span class="w"> </span>HEAD<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="c1"># 847 lines changed</span>

git<span class="w"> </span>revert<span class="w"> </span>HEAD
<span class="c1"># Back to working code from before &quot;improvements&quot;</span>
</pre></div>
</div>
</section>
</div></section>
<hr class="docutils" />
<section id="example-2-ask-ai-for-diagnostic-feedback-before-refactoring">
<h3><span class="section-number">4.3.1.2. </span>Example 2: Ask AI for Diagnostic Feedback Before Refactoring<a class="headerlink" href="#example-2-ask-ai-for-diagnostic-feedback-before-refactoring" title="Link to this heading">#</a></h3>
<p>The user has working code but suspects it could be improved. Instead of asking AI to fix everything, they request analysis first. The AI identifies specific improvement opportunities. The user evaluates each suggestion in the context of their project; some are valuable, others don’t fit their codebase conventions. They choose one high-priority issue to address first and give AI a focused, specific refactoring objective. This diagnostic approach works even for less experienced developers who might not recognize unideal coding patterns themselves.</p>
<div class="proof example dropdown admonition" id="rule10-good-ex1">
<p class="admonition-title"><span class="caption-number">Example 4.10 </span> (Ask AI for Diagnostic Feedback Before Refactoring)</p>
<section class="example-content" id="proof-content">
<p><strong>User Prompt:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Review</span> <span class="n">this</span> <span class="n">brain</span> <span class="n">connectivity</span> <span class="n">analysis</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">identify</span> <span class="n">specific</span> <span class="n">improvement</span> 
<span class="n">opportunities</span><span class="o">.</span> <span class="n">Don</span><span class="s1">&#39;t implement anything yet; just analyze what you see.</span>

<span class="p">[</span><span class="n">pastes</span> <span class="mi">150</span> <span class="n">lines</span> <span class="n">of</span> <span class="n">working</span> <span class="n">code</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>AI Response:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I</span><span class="s1">&#39;ve identified several improvement opportunities:</span>

<span class="mf">1.</span> <span class="o">**</span><span class="n">Repeated</span> <span class="n">validation</span> <span class="n">logic</span><span class="o">**</span> <span class="p">(</span><span class="n">Lines</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">103</span><span class="p">)</span>
   <span class="o">-</span> <span class="n">Input</span> <span class="n">shape</span> <span class="n">checking</span> <span class="n">repeated</span> <span class="ow">in</span> <span class="mi">3</span> <span class="n">functions</span>
   <span class="o">-</span> <span class="n">NaN</span> <span class="n">detection</span> <span class="n">duplicated</span> <span class="n">across</span> <span class="n">methods</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Extract</span> <span class="n">into</span> <span class="n">validate_connectivity_matrix</span><span class="p">()</span> <span class="n">function</span>

<span class="mf">2.</span> <span class="o">**</span><span class="n">Deeply</span> <span class="n">nested</span> <span class="n">conditionals</span><span class="o">**</span> <span class="p">(</span><span class="n">Lines</span> <span class="mi">45</span><span class="o">-</span><span class="mi">62</span><span class="p">)</span>
   <span class="o">-</span> <span class="mi">4</span> <span class="n">levels</span> <span class="n">of</span> <span class="n">nesting</span> <span class="ow">in</span> <span class="n">threshold_matrix</span><span class="p">()</span>
   <span class="o">-</span> <span class="n">Logic</span> <span class="n">flow</span> <span class="n">hard</span> <span class="n">to</span> <span class="n">follow</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Extract</span> <span class="n">conditions</span> <span class="n">into</span> <span class="n">guard</span> <span class="n">clauses</span> <span class="ow">or</span> <span class="n">helper</span> <span class="n">functions</span>

<span class="mf">3.</span> <span class="o">**</span><span class="n">Inconsistent</span> <span class="n">naming</span><span class="o">**</span> 
   <span class="o">-</span> <span class="n">Mix</span> <span class="n">of</span> <span class="s1">&#39;mat&#39;</span><span class="p">,</span> <span class="s1">&#39;matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;conn_matrix&#39;</span> <span class="k">for</span> <span class="n">same</span> <span class="n">concept</span>
   <span class="o">-</span> <span class="n">Function</span> <span class="n">names</span> <span class="n">inconsistent</span><span class="p">:</span> <span class="n">compute_metrics</span><span class="p">()</span> <span class="n">vs</span> <span class="n">calculateStats</span><span class="p">()</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Standardize</span> <span class="n">to</span> <span class="s1">&#39;connectivity_matrix&#39;</span> <span class="ow">and</span> <span class="n">snake_case</span> <span class="n">throughout</span>

<span class="mf">4.</span> <span class="o">**</span><span class="n">Magic</span> <span class="n">numbers</span><span class="o">**</span> <span class="p">(</span><span class="n">Lines</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">91</span><span class="p">)</span>
   <span class="o">-</span> <span class="n">Hardcoded</span> <span class="n">values</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.7</span> <span class="n">without</span> <span class="n">explanation</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Extract</span> <span class="k">as</span> <span class="n">named</span> <span class="n">constants</span> <span class="k">with</span> <span class="n">documentation</span>

<span class="mf">5.</span> <span class="o">**</span><span class="n">Tight</span> <span class="n">coupling</span><span class="o">**</span>
   <span class="o">-</span> <span class="n">StatisticalAnalysis</span> <span class="n">directly</span> <span class="n">instantiates</span> <span class="n">Preprocessor</span>
   <span class="o">-</span> <span class="n">Hard</span> <span class="n">to</span> <span class="n">test</span> <span class="ow">or</span> <span class="n">swap</span> <span class="n">implementations</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Use</span> <span class="n">dependency</span> <span class="n">injection</span> <span class="n">pattern</span>

<span class="mf">6.</span> <span class="o">**</span><span class="n">Missing</span> <span class="nb">type</span> <span class="n">hints</span><span class="o">**</span>
   <span class="o">-</span> <span class="n">Function</span> <span class="n">signatures</span> <span class="n">don</span><span class="s1">&#39;t specify types</span>
   <span class="o">-</span> <span class="n">Recommendation</span><span class="p">:</span> <span class="n">Add</span> <span class="nb">type</span> <span class="n">annotations</span> <span class="k">for</span> <span class="n">better</span> <span class="n">IDE</span> <span class="n">support</span>
</pre></div>
</div>
<p><strong>User’s Thought Process:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Let me evaluate each suggestion for our project:

1. Repeated validation - YES. I keep copying the same validation and it&#39;s 
   error-prone. This is a real problem.
   → Priority: HIGH

2. Nested conditionals - Hmm, the nesting actually makes the logic clear in 
   this case. The threshold logic is inherently complex.
   → Priority: SKIP (not worth changing)

3. Inconsistent naming - Good catch. This does hurt readability.
   → Priority: MEDIUM (do after validation)

4. Magic numbers - The 0.05 is standard p-value threshold, but 0.7 connectivity 
   threshold should definitely be named.
   → Priority: MEDIUM

5. Tight coupling - True, but our entire codebase doesn&#39;t use dependency 
   injection. Introducing it here would be inconsistent with project style.
   → Priority: SKIP (doesn&#39;t fit our conventions)

6. Type hints - Nice to have but not critical right now.
   → Priority: LOW (maybe later)

Decision: Start with #1 (validation extraction). Clear win, high impact.
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Good</span> <span class="n">analysis</span><span class="o">.</span> <span class="n">Let</span><span class="s1">&#39;s address #1 first: the repeated validation logic.</span>

<span class="n">Create</span> <span class="n">a</span> <span class="n">validation</span> <span class="n">function</span><span class="p">:</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_connectivity_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate connectivity matrix meets requirements.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : np.ndarray</span>
<span class="sd">        Connectivity matrix to validate</span>
<span class="sd">    allow_nan : bool</span>
<span class="sd">        Whether NaN values are acceptable</span>
<span class="sd">    require_symmetric : bool</span>
<span class="sd">        Whether matrix must be symmetric</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If validation fails, with specific explanation of what&#39;s wrong</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="n">Then</span> <span class="n">refactor</span> <span class="n">compute_correlation</span><span class="p">(),</span> <span class="n">threshold_matrix</span><span class="p">(),</span> <span class="ow">and</span> <span class="n">compute_metrics</span><span class="p">()</span> 
<span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="n">validator</span><span class="o">.</span>

<span class="n">Do</span> <span class="n">this</span> <span class="n">incrementally</span><span class="p">:</span>
<span class="mf">1.</span> <span class="n">Show</span> <span class="n">me</span> <span class="n">the</span> <span class="n">validator</span> <span class="n">implementation</span> <span class="n">first</span>
<span class="mf">2.</span> <span class="n">Then</span> <span class="n">update</span> <span class="n">compute_correlation</span><span class="p">()</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span> <span class="p">(</span><span class="n">I</span><span class="s1">&#39;ll test)</span>
<span class="mf">3.</span> <span class="n">Then</span> <span class="n">threshold_matrix</span><span class="p">()</span> <span class="p">(</span><span class="n">I</span><span class="s1">&#39;ll test)  </span>
<span class="mf">4.</span> <span class="n">Then</span> <span class="n">compute_metrics</span><span class="p">()</span> <span class="p">(</span><span class="n">I</span><span class="s1">&#39;ll test)</span>

<span class="n">Don</span><span class="s1">&#39;t change anything else; just the validation extraction.</span>
</pre></div>
</div>
<p><strong>AI Implements Validator:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">validate_connectivity_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate connectivity matrix meets requirements.&quot;&quot;&quot;</span>
    
    <span class="c1"># Check type</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected numpy array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check dimensions</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected 2D array, got </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">D&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check square</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected square matrix, got shape </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for NaN</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_nan</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matrix</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix contains NaN values&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check symmetry</span>
    <span class="k">if</span> <span class="n">require_symmetric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix is not symmetric&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p><strong>User:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Good</span><span class="o">.</span> <span class="n">Now</span> <span class="n">update</span> <span class="n">compute_correlation</span><span class="p">()</span> <span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="n">validator</span> <span class="n">at</span> <span class="n">the</span> <span class="n">start</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>AI Updates First Function:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_correlation</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute correlation matrix from timeseries.&quot;&quot;&quot;</span>
    <span class="c1"># OLD: Manual validation code here (5 lines)</span>
    <span class="c1"># NEW: Use validator</span>
    <span class="c1"># Note: Don&#39;t validate here since input is timeseries, not connectivity matrix</span>
    
    <span class="n">conn_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
    
    <span class="c1"># Validate output</span>
    <span class="n">validate_connectivity_matrix</span><span class="p">(</span><span class="n">conn_matrix</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">conn_matrix</span>
</pre></div>
</div>
<p><strong>User Tests:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>✓ All tests pass
✓ git diff shows only compute_correlation() changed
✓ Validation logic now centralized

Continue with threshold_matrix()...
</pre></div>
</div>
</section>
</div></section>
<hr class="docutils" />
<section id="example-3-incremental-refactoring-with-testing">
<h3><span class="section-number">4.3.1.3. </span>Example 3: Incremental Refactoring with Testing<a class="headerlink" href="#example-3-incremental-refactoring-with-testing" title="Link to this heading">#</a></h3>
<p>Following the diagnostic approach from Example 2, the user now implements one focused refactoring objective. They work incrementally: make one change, run tests, verify behavior unchanged, commit. When a change breaks something, they catch it immediately and can revert or fix because only one thing changed. This disciplined approach maintains a working codebase throughout the refactoring process. The example shows multiple small steps with verification at each point.</p>
<div class="proof example dropdown admonition" id="rule10-good-ex2">
<p class="admonition-title"><span class="caption-number">Example 4.11 </span> (Incremental Refactoring with Testing)</p>
<section class="example-content" id="proof-content">
<p><strong>Context:</strong> Following Example 2’s diagnosis, user is implementing validation extraction</p>
<p><strong>Step 1: Create validator function</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># New function added</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_connectivity_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># [implementation from Example 2]</span>
</pre></div>
</div>
<p><strong>Test Step 1:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_validation.py<span class="w"> </span>-v
<span class="c1"># All validation tests pass</span>
git<span class="w"> </span>add<span class="w"> </span>src/connectivity/validation.py
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add validate_connectivity_matrix function</span>

<span class="s2">Extracts repeated validation logic into reusable function.</span>
<span class="s2">No behavior changes yet; just adding the function.&quot;</span>
</pre></div>
</div>
<p><strong>Step 2: Update first function</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_correlation</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute correlation matrix from timeseries.&quot;&quot;&quot;</span>
    <span class="c1"># Replace inline validation with validator call</span>
    <span class="n">conn_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
    <span class="n">validate_connectivity_matrix</span><span class="p">(</span><span class="n">conn_matrix</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn_matrix</span>
</pre></div>
</div>
<p><strong>Test Step 2:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_correlation.py<span class="w"> </span>-v
<span class="c1"># ✓ All pass - behavior unchanged</span>

git<span class="w"> </span>add<span class="w"> </span>src/connectivity/correlation.py
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Update compute_correlation to use centralized validation</span>

<span class="s2">Removes duplicate validation code. Behavior unchanged.&quot;</span>
</pre></div>
</div>
<p><strong>Step 3: Update second function</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">threshold_matrix</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Threshold connectivity matrix.&quot;&quot;&quot;</span>
    <span class="c1"># Replace inline validation</span>
    <span class="n">validate_connectivity_matrix</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> 
                                <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">thresholded</span> <span class="o">=</span> <span class="n">connectivity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thresholded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">thresholded</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Preserve diagonal</span>
    
    <span class="k">return</span> <span class="n">thresholded</span>
</pre></div>
</div>
<p><strong>Test Step 3:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_threshold.py<span class="w"> </span>-v
<span class="c1"># ✓ All pass</span>

git<span class="w"> </span>add<span class="w"> </span>src/connectivity/threshold.py<span class="w">  </span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Update threshold_matrix to use centralized validation</span>

<span class="s2">Second function migrated to shared validator.&quot;</span>
</pre></div>
</div>
<p><strong>Step 4: Update third function</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute graph metrics from connectivity.&quot;&quot;&quot;</span>
    <span class="c1"># Replace inline validation</span>
    <span class="n">validate_connectivity_matrix</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span>
                                <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">require_symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Compute metrics</span>
    <span class="c1"># [rest of implementation]</span>
</pre></div>
</div>
<p><strong>Test Step 4:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_metrics.py<span class="w"> </span>-v

<span class="c1"># FAILURE!</span>
<span class="c1"># test_metrics_with_nan FAILED - ValueError: Matrix contains NaN values</span>
</pre></div>
</div>
<p><strong>User Analysis:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Wait</span><span class="p">,</span> <span class="n">the</span> <span class="n">test</span> <span class="ow">is</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">that</span> <span class="n">compute_metrics</span><span class="p">()</span> <span class="n">handles</span> <span class="n">NaN</span> <span class="n">gracefully</span><span class="p">,</span>
<span class="n">but</span> <span class="n">now</span> <span class="n">the</span> <span class="n">validator</span> <span class="ow">is</span> <span class="n">rejecting</span> <span class="n">NaN</span> <span class="n">before</span> <span class="n">we</span> <span class="n">get</span> <span class="n">to</span> <span class="n">that</span> <span class="n">logic</span><span class="o">.</span>

<span class="n">Looking</span> <span class="n">at</span> <span class="n">the</span> <span class="n">old</span> <span class="n">code</span><span class="o">...</span> <span class="n">we</span> <span class="n">were</span> <span class="n">actually</span> <span class="n">checking</span> <span class="k">for</span> <span class="n">NaN</span> <span class="ow">and</span> <span class="n">handling</span> <span class="n">it</span>
<span class="n">specifically</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">function</span><span class="o">.</span> <span class="n">The</span> <span class="n">validator</span> <span class="ow">is</span> <span class="n">too</span> <span class="n">strict</span> <span class="n">here</span><span class="o">.</span>

<span class="n">Option</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Change</span> <span class="n">validator</span> <span class="n">call</span> <span class="n">to</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">True</span>
<span class="n">Option</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Keep</span> <span class="n">the</span> <span class="n">validation</span> <span class="n">strict</span> <span class="n">but</span> <span class="n">update</span> <span class="n">the</span> <span class="n">test</span>

<span class="n">Checking</span> <span class="n">the</span> <span class="n">specification</span><span class="o">...</span> <span class="n">compute_metrics</span><span class="p">()</span> <span class="n">should</span> <span class="n">reject</span> <span class="n">NaN</span> <span class="p">(</span><span class="n">unlike</span>
<span class="n">compute_correlation</span> <span class="n">which</span> <span class="n">allows</span> <span class="n">it</span><span class="p">)</span><span class="o">.</span> <span class="n">The</span> <span class="n">old</span> <span class="n">test</span> <span class="n">was</span> <span class="n">wrong</span><span class="o">.</span> <span class="n">Let</span> <span class="n">me</span> <span class="n">fix</span> <span class="n">the</span> <span class="n">test</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>Fix Test:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_metrics_with_nan</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;compute_metrics should reject NaN values.&quot;&quot;&quot;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># OLD: Expected this to handle gracefully</span>
    <span class="c1"># NEW: Should raise ValueError</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;NaN&quot;</span><span class="p">):</span>
        <span class="n">compute_metrics</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Test Again:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_metrics.py<span class="w"> </span>-v
<span class="c1"># ✓ All pass now</span>

git<span class="w"> </span>add<span class="w"> </span>src/connectivity/metrics.py<span class="w"> </span>tests/test_metrics.py
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Update compute_metrics to use centralized validation</span>

<span class="s2">Fixed test to match intended behavior: NaN should be rejected.</span>
<span class="s2">All validation logic now centralized.&quot;</span>
</pre></div>
</div>
<p><strong>Final Verification:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run full test suite</span>
pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="c1"># ✓ All 47 tests pass</span>

<span class="c1"># Check what changed overall</span>
git<span class="w"> </span>log<span class="w"> </span>--oneline<span class="w"> </span>-5
<span class="c1"># 4 commits, each focused on one change</span>
<span class="c1"># Easy to review, easy to revert if needed</span>
</pre></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>Validation logic successfully centralized</p></li>
<li><p>All three functions refactored</p></li>
<li><p>One test bug caught and fixed</p></li>
<li><p>Code works throughout entire process</p></li>
<li><p>Clear commit history documents what happened</p></li>
</ul>
</section>
</div></section>
<hr class="docutils" />
<section id="example-4-performance-optimization-with-baseline-metrics">
<h3><span class="section-number">4.3.1.4. </span>Example 4: Performance Optimization with Baseline Metrics<a class="headerlink" href="#example-4-performance-optimization-with-baseline-metrics" title="Link to this heading">#</a></h3>
<p>The user identifies a performance bottleneck through profiling. Before optimizing, they establish baseline metrics. They request one specific optimization from AI, verify it actually improves performance, and confirm correctness is maintained. When an “optimization” actually makes things worse, they catch it immediately by comparing to the baseline and revert. This metrics-driven approach prevents premature optimization and ensures changes provide real benefits.</p>
<div class="proof example dropdown admonition" id="rule10-good-ex3">
<p class="admonition-title"><span class="caption-number">Example 4.12 </span> (Performance Optimization with Baseline Metrics)</p>
<section class="example-content" id="proof-content">
<p><strong>User Analysis:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Current performance profiling shows:
- Total processing: 45 seconds per subject
- Breakdown:
  * Loading data: 3s
  * Motion correction: 8s
  * Correlation computation: 28s  ← BOTTLENECK
  * Statistical tests: 6s

The correlation computation is the problem. Let me look at the code...
</pre></div>
</div>
<p><strong>Current Implementation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_connectivity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pairwise correlations.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        timeseries: (n_regions, n_timepoints) array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_regions</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_regions</span><span class="p">,</span> <span class="n">n_regions</span><span class="p">))</span>
    
    <span class="c1"># Nested loops - probably the bottleneck</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_regions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_regions</span><span class="p">):</span>
            <span class="n">connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">connectivity</span>
</pre></div>
</div>
<p><strong>Establish Baseline:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create benchmark</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">benchmark_connectivity</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Benchmark current implementation.&quot;&quot;&quot;</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># Typical data size</span>
    
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute_connectivity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">times</span><span class="p">),</span>
        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">times</span><span class="p">),</span>
        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">times</span><span class="p">),</span>
        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="p">}</span>

<span class="n">baseline</span> <span class="o">=</span> <span class="n">benchmark_connectivity</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline: </span><span class="si">{</span><span class="n">baseline</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s ± </span><span class="si">{</span><span class="n">baseline</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="c1"># Baseline: 2.847s ± 0.043s</span>
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Optimize</span> <span class="n">compute_connectivity</span><span class="p">()</span> <span class="k">for</span> <span class="n">speed</span><span class="o">.</span> <span class="n">Current</span> <span class="n">performance</span><span class="p">:</span> <span class="mf">2.85</span> <span class="n">seconds</span><span class="o">.</span>

<span class="n">SPECIFIC</span> <span class="n">OPTIMIZATION</span><span class="p">:</span>
<span class="n">Replace</span> <span class="n">the</span> <span class="n">nested</span> <span class="n">loop</span> <span class="k">with</span> <span class="n">vectorized</span> <span class="n">numpy</span> <span class="n">operation</span><span class="o">.</span> <span class="n">The</span> <span class="n">current</span> 
<span class="n">implementation</span> <span class="n">calls</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">()</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span> <span class="n">times</span> <span class="p">(</span><span class="mi">100</span><span class="n">x100</span><span class="p">)</span><span class="o">.</span> <span class="n">We</span> <span class="n">should</span> <span class="n">call</span> 
<span class="n">it</span> <span class="n">once</span> <span class="n">on</span> <span class="n">the</span> <span class="n">entire</span> <span class="n">timeseries</span> <span class="n">matrix</span><span class="o">.</span>

<span class="n">CONSTRAINTS</span><span class="p">:</span>
<span class="o">-</span> <span class="n">Must</span> <span class="n">maintain</span> <span class="n">identical</span> <span class="n">output</span> <span class="p">(</span><span class="n">within</span> <span class="n">floating</span> <span class="n">point</span> <span class="n">tolerance</span><span class="p">)</span>
<span class="o">-</span> <span class="n">Must</span> <span class="n">handle</span> <span class="n">NaN</span> <span class="n">values</span> <span class="n">the</span> <span class="n">same</span> <span class="n">way</span>
<span class="o">-</span> <span class="n">Should</span> <span class="n">use</span> <span class="n">numpy</span> <span class="n">only</span> <span class="p">(</span><span class="n">no</span> <span class="n">new</span> <span class="n">dependencies</span><span class="p">)</span>

<span class="n">TARGET</span><span class="p">:</span> <span class="n">Under</span> <span class="mf">0.1</span> <span class="n">seconds</span> <span class="p">(</span><span class="mi">30</span><span class="n">x</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Show</span> <span class="n">implementation</span><span class="p">,</span> <span class="ow">and</span> <span class="n">I</span><span class="s1">&#39;ll benchmark it.</span>
</pre></div>
</div>
<p><strong>AI Optimized Version:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_connectivity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pairwise correlations using vectorized operations.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        timeseries: (n_regions, n_timepoints) array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Single call to corrcoef instead of nested loops</span>
    <span class="n">connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connectivity</span>
</pre></div>
</div>
<p><strong>User Benchmarks:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test correctness first</span>
<span class="n">old_result</span> <span class="o">=</span> <span class="n">compute_connectivity_old</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">new_result</span> <span class="o">=</span> <span class="n">compute_connectivity</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">old_result</span><span class="p">,</span> <span class="n">new_result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Correctness verified&quot;</span><span class="p">)</span>

<span class="c1"># Benchmark new version</span>
<span class="n">new_perf</span> <span class="o">=</span> <span class="n">benchmark_connectivity</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New: </span><span class="si">{</span><span class="n">new_perf</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s ± </span><span class="si">{</span><span class="n">new_perf</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="c1"># New: 0.008s ± 0.001s</span>

<span class="c1"># Compare</span>
<span class="n">speedup</span> <span class="o">=</span> <span class="n">baseline</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">new_perf</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Speedup: </span><span class="si">{</span><span class="n">speedup</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
<span class="c1"># Speedup: 355.9x</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Target achieved (&gt;30x improvement)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Full Test Suite:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_connectivity.py<span class="w"> </span>-v
<span class="c1"># ✓ All 15 tests pass</span>
<span class="c1"># No behavior changes despite major performance improvement</span>
</pre></div>
</div>
<p><strong>User:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Excellent</span><span class="o">.</span> <span class="n">Commit</span> <span class="n">this</span> <span class="n">optimization</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>Alternative Scenario: “Optimization” Makes Things Worse:</strong></p>
<p><strong>AI “Optimized” Version:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_connectivity_v2</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize using sparse matrix operations.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
    
    <span class="c1"># Convert to sparse (thinking this will be faster)</span>
    <span class="n">sparse_ts</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
    <span class="c1"># [complicated sparse correlation implementation]</span>
</pre></div>
</div>
<p><strong>User Benchmarks:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_perf</span> <span class="o">=</span> <span class="n">benchmark_connectivity_v2</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparse version: </span><span class="si">{</span><span class="n">new_perf</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="c1"># Sparse version: 4.231s</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparison to baseline: </span><span class="si">{</span><span class="n">new_perf</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">baseline</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
<span class="c1"># Comparison to baseline: 1.49x SLOWER</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✗ This &#39;optimization&#39; actually made it worse!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>User Summary:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">sparse</span> <span class="n">matrix</span> <span class="n">approach</span> <span class="ow">is</span> <span class="n">actually</span> <span class="n">slower</span> <span class="n">than</span> <span class="n">the</span> <span class="n">original</span><span class="o">.</span> <span class="n">The</span> <span class="n">overhead</span> 
<span class="n">of</span> <span class="n">sparse</span> <span class="n">operations</span> <span class="n">doesn</span><span class="s1">&#39;t pay off for dense correlation matrices.</span>

<span class="n">Reverting</span> <span class="n">to</span> <span class="n">the</span> <span class="n">simple</span> <span class="n">vectorized</span> <span class="n">version</span> <span class="n">which</span> <span class="n">was</span> <span class="mi">355</span><span class="n">x</span> <span class="n">faster</span><span class="o">.</span>
</pre></div>
</div>
</section>
</div></section>
<section id="example-5-ai-breaks-code-during-refactoring">
<h3><span class="section-number">4.3.1.5. </span>Example 5: AI Breaks Code During Refactoring<a class="headerlink" href="#example-5-ai-breaks-code-during-refactoring" title="Link to this heading">#</a></h3>
<p>The user requests a specific refactoring. The AI implements it but subtly changes behavior in the process. Because the user tests after each change (following the incremental approach), they catch the breakage immediately. They can identify exactly what went wrong, provide corrected requirements, and try again. If they’d made multiple changes at once, they wouldn’t know which change caused the problem.</p>
<div class="proof example dropdown admonition" id="rule10-good-ex4">
<p class="admonition-title"><span class="caption-number">Example 4.13 </span> (AI Breaks Code During Refactoring)</p>
<section class="example-content" id="proof-content">
<p><strong>User Request:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Extract</span> <span class="n">the</span> <span class="n">network</span> <span class="n">thresholding</span> <span class="n">logic</span> <span class="kn">from</span><span class="w"> </span><span class="nn">analyze_network</span><span class="p">()</span> <span class="n">into</span> <span class="n">a</span> <span class="n">separate</span> 
<span class="n">function</span> <span class="n">threshold_by_density</span><span class="p">()</span><span class="o">.</span>

<span class="n">Current</span> <span class="n">code</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">analyze_network</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze network properties at given density.&quot;&quot;&quot;</span>
    <span class="c1"># Threshold to keep top X% of connections</span>
    <span class="n">threshold_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">),</span> 
                                   <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">density</span><span class="p">))</span>
    
    <span class="n">thresholded</span> <span class="o">=</span> <span class="n">connectivity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thresholded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Compute metrics on thresholded network</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_graph_metrics</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Extract</span> <span class="n">the</span> <span class="n">thresholding</span> <span class="n">logic</span> <span class="p">(</span><span class="n">lines</span> <span class="mi">3</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span> <span class="n">into</span><span class="p">:</span>

<span class="k">def</span><span class="w"> </span><span class="nf">threshold_by_density</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keep only top density% of connections by absolute value.&quot;&quot;&quot;</span>
    <span class="c1"># Extract threshold computation and application here</span>
    <span class="k">return</span> <span class="n">thresholded_matrix</span>

<span class="n">Then</span> <span class="n">update</span> <span class="n">analyze_network</span><span class="p">()</span> <span class="n">to</span> <span class="n">call</span> <span class="n">this</span> <span class="n">function</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>AI Implementation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">threshold_by_density</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keep only top density% of connections by absolute value.&quot;&quot;&quot;</span>
    <span class="n">threshold_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span>  <span class="c1"># BUG: removed np.abs()</span>
                                   <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">density</span><span class="p">))</span>
    
    <span class="n">thresholded</span> <span class="o">=</span> <span class="n">connectivity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thresholded</span><span class="p">[</span><span class="n">connectivity_matrix</span> <span class="o">&lt;</span> <span class="n">threshold_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># BUG: wrong comparison</span>
    
    <span class="k">return</span> <span class="n">thresholded</span>

<span class="k">def</span><span class="w"> </span><span class="nf">analyze_network</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze network properties at given density.&quot;&quot;&quot;</span>
    <span class="n">thresholded</span> <span class="o">=</span> <span class="n">threshold_by_density</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_graph_metrics</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</pre></div>
</div>
<p><strong>User Tests:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_network_analysis.py<span class="w"> </span>-v

FAILED<span class="w"> </span>tests/test_network_analysis.py::test_threshold_by_density
FAILED<span class="w"> </span>tests/test_network_analysis.py::test_analyze_symmetric_network

<span class="c1"># Two tests failed after the refactoring</span>
</pre></div>
</div>
<p><strong>User Investigation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check what&#39;s wrong</span>
<span class="n">test_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">],</span>
    <span class="p">[</span> <span class="mf">0.8</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span>  <span class="mf">0.2</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.4</span><span class="p">],</span>
    <span class="p">[</span> <span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>  <span class="mf">0.4</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">threshold_by_density</span><span class="p">(</span><span class="n">test_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c1"># Result shows negative values are kept, positive weak connections removed</span>
<span class="c1"># This is BACKWARDS from expected behavior</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected: Keep strongest connections by absolute value&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Actual: Threshold is based on raw values, not absolute values&quot;</span><span class="p">)</span>

<span class="c1"># The bug: AI removed np.abs() from percentile calculation</span>
<span class="c1"># AND used wrong comparison (&lt; instead of checking absolute value)</span>
</pre></div>
</div>
<p><strong>User to AI:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">refactoring</span> <span class="n">introduced</span> <span class="n">two</span> <span class="n">bugs</span><span class="p">:</span>

<span class="n">BUG</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Line</span> <span class="mi">3</span> <span class="n">should</span> <span class="n">be</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
       <span class="n">You</span> <span class="n">removed</span> <span class="n">the</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">so</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="n">computed</span> <span class="n">on</span> <span class="n">raw</span> <span class="n">values</span>
       <span class="n">instead</span> <span class="n">of</span> <span class="n">absolute</span> <span class="n">values</span><span class="o">.</span> <span class="n">This</span> <span class="n">means</span> <span class="n">strong</span> <span class="n">negative</span> <span class="n">correlations</span>
       <span class="n">get</span> <span class="n">incorrectly</span> <span class="n">removed</span><span class="o">.</span>

<span class="n">BUG</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Line</span> <span class="mi">6</span> <span class="n">should</span> <span class="n">threshold</span> <span class="n">by</span> <span class="n">absolute</span> <span class="n">value</span><span class="p">:</span> 
       <span class="n">thresholded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
       <span class="n">Your</span> <span class="n">version</span> <span class="n">only</span> <span class="n">removes</span> <span class="n">values</span> <span class="n">below</span> <span class="n">threshold</span><span class="p">,</span> <span class="ow">not</span> <span class="n">weak</span> <span class="n">values</span>
       <span class="ow">in</span> <span class="n">general</span><span class="o">.</span>

<span class="n">The</span> <span class="n">function</span> <span class="n">should</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">top</span> <span class="n">X</span><span class="o">%</span> <span class="n">strongest</span> <span class="n">connections</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">sign</span><span class="o">.</span>

<span class="n">Fix</span> <span class="n">both</span> <span class="n">bugs</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>AI Corrected Version:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">threshold_by_density</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keep only top density% of connections by absolute value.&quot;&quot;&quot;</span>
    <span class="c1"># Threshold based on absolute values</span>
    <span class="n">threshold_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">connectivity_matrix</span><span class="p">),</span>
                                   <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">density</span><span class="p">))</span>
    
    <span class="n">thresholded</span> <span class="o">=</span> <span class="n">connectivity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Zero out connections weaker than threshold (by absolute value)</span>
    <span class="n">thresholded</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholded</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="n">thresholded</span>
</pre></div>
</div>
<p><strong>User Tests Again:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests/test_network_analysis.py<span class="w"> </span>-v
<span class="c1"># ✓ All tests pass</span>

<span class="c1"># Verify behavior explicitly</span>
<span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>threshold_by_density<span class="o">(</span>test_matrix,<span class="w"> </span><span class="nv">density</span><span class="o">=</span><span class="m">0</span>.5<span class="o">)</span>
<span class="nv">strong_connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>np.sum<span class="o">(</span>result<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span>-<span class="w"> </span><span class="m">4</span><span class="w">  </span><span class="c1"># Exclude diagonal</span>
print<span class="o">(</span>f<span class="s2">&quot;Strong connections kept: {strong_connections}&quot;</span><span class="o">)</span>
<span class="c1"># Strong connections kept: 4 (top 50% of 8 off-diagonal connections)</span>

print<span class="o">(</span><span class="s2">&quot;✓ Behavior now matches original implementation&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p><strong>User Reflection:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Good</span> <span class="n">thing</span> <span class="n">I</span> <span class="n">tested</span> <span class="n">immediately</span> <span class="n">after</span> <span class="n">the</span> <span class="n">refactoring</span><span class="o">.</span> <span class="n">If</span> <span class="n">I</span><span class="s1">&#39;d made multiple </span>
<span class="n">changes</span> <span class="n">at</span> <span class="n">once</span><span class="p">,</span> <span class="n">I</span> <span class="n">wouldn</span><span class="s1">&#39;t know which one introduced the bug.</span>

<span class="n">The</span> <span class="n">incremental</span> <span class="n">approach</span> <span class="n">caught</span> <span class="n">this</span> <span class="n">quickly</span><span class="p">:</span>
<span class="mf">1.</span> <span class="n">One</span> <span class="n">change</span> <span class="p">(</span><span class="n">extraction</span><span class="p">)</span>
<span class="mf">2.</span> <span class="n">Test</span> <span class="n">immediately</span>  
<span class="mf">3.</span> <span class="n">Caught</span> <span class="n">bug</span>
<span class="mf">4.</span> <span class="n">Fixed</span> <span class="ow">and</span> <span class="n">verified</span>
<span class="mf">5.</span> <span class="n">Now</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="nb">next</span> <span class="n">refactoring</span>

<span class="n">If</span> <span class="n">I</span><span class="s1">&#39;d asked AI to &quot;improve the whole module,&quot; this bug would be buried </span>
<span class="n">among</span> <span class="n">dozens</span> <span class="n">of</span> <span class="n">changes</span> <span class="ow">and</span> <span class="n">much</span> <span class="n">harder</span> <span class="n">to</span> <span class="n">diagnose</span><span class="o">.</span>
</pre></div>
</div>
</section>
</div></section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./rules/quality"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="rule9.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4.2. </span>Rule 9: Critically Review Generated Code</p>
      </div>
    </a>
    <a class="right-next"
       href="../../conclusion/conclusion.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Conclusion</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-separates-positive-from-flawed-examples">4.3.1. What separates positive from flawed examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-vague-improve-this-request">4.3.1.1. Example 1: Vague “Improve This” Request</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-ask-ai-for-diagnostic-feedback-before-refactoring">4.3.1.2. Example 2: Ask AI for Diagnostic Feedback Before Refactoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-incremental-refactoring-with-testing">4.3.1.3. Example 3: Incremental Refactoring with Testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-performance-optimization-with-baseline-metrics">4.3.1.4. Example 4: Performance Optimization with Baseline Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-ai-breaks-code-during-refactoring">4.3.1.5. Example 5: AI Breaks Code During Refactoring</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Eric W. Bridgeford, Iain Campbell, Zijiao Chen, Harrison Ritz, Joachim Vandekerckhove, Russell A. Poldrack
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>